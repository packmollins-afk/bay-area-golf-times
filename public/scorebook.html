<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Scorebook | Bay Area Golf</title>
  <meta name="description" content="Track your rounds, log scores, and earn your Bay Area Golf Passport by playing all 28 public courses.">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/animations.css">
  <style>
    :root {
      --primary: #2d5a27;
      --primary-light: #4a7a3f;
      --primary-dark: #1a3d17;
      --bg: #f4f1e8;
      --bg-paper: #f9f6ef;
      --card-bg: #fffef9;
      --text: #3d2914;
      --text-muted: #6b5344;
      --border: #c4a882;
      --border-light: #ddd0bc;
      --gold: #b8860b;
      --success: #2d5a27;
      --error: #c62828;
      --anim-fast: 200ms;
      --anim-normal: 350ms;
      --ease-out: cubic-bezier(0.33, 1, 0.68, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Source Serif 4', Georgia, serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #f4f1e8;
      padding: 24px 0;
      border-bottom: 4px solid var(--border);
    }
    header .container { display: flex; justify-content: space-between; align-items: center; }
    header h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.8rem;
      font-weight: 700;
    }
    .header-nav { display: flex; gap: 10px; }
    .nav-link {
      color: #f4f1e8;
      text-decoration: none;
      font-family: 'Playfair Display', Georgia, serif;
      padding: 8px 16px;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 4px;
      transition: all 0.2s;
    }
    .nav-link:hover { background: rgba(255,255,255,0.1); border-color: #fff; }

    .page-title {
      text-align: center;
      padding: 40px 0;
    }
    .page-title h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 2.2rem;
      margin-bottom: 8px;
    }
    .page-title p { color: var(--text-muted); font-style: italic; }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 14px 28px;
      background: white;
      border: 2px solid var(--border-light);
      border-radius: 30px;
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out);
      box-shadow: 0 2px 8px rgba(61, 41, 20, 0.06);
      position: relative;
      overflow: hidden;
    }
    .tab-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255,255,255,0.5));
      opacity: 0;
      transition: opacity var(--anim-fast);
    }
    .tab-btn:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(61, 41, 20, 0.12);
    }
    .tab-btn:hover::before { opacity: 1; }
    .tab-btn:active { transform: translateY(-1px); }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #f4f1e8;
      border-color: transparent;
      box-shadow: 0 4px 16px rgba(45, 90, 39, 0.3);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Auth Required */
    .auth-required {
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
      padding: 60px 20px;
      background: var(--card-bg);
      border: 2px solid var(--border-light);
      border-radius: 8px;
    }
    .auth-required-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: var(--bg-paper);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .auth-required-icon svg {
      width: 36px;
      height: 36px;
      stroke: var(--text-muted);
      fill: none;
      stroke-width: 2;
    }
    .auth-required h3 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.4rem;
      margin-bottom: 12px;
    }
    .auth-required p {
      color: var(--text-muted);
      margin-bottom: 24px;
    }
    .cta-btn {
      display: inline-block;
      padding: 14px 28px;
      background: var(--primary);
      color: #f4f1e8;
      text-decoration: none;
      border-radius: 4px;
      font-family: 'Playfair Display', Georgia, serif;
      font-weight: 600;
      transition: background 0.2s;
      border: none;
      cursor: pointer;
    }
    .cta-btn:hover { background: var(--primary-light); }

    /* Log Round Form */
    .log-round-form {
      max-width: 500px;
      margin: 0 auto;
      background: var(--card-bg);
      border: 2px solid var(--border-light);
      border-radius: 8px;
      padding: 32px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-family: 'Playfair Display', Georgia, serif;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-light);
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
      background: var(--bg-paper);
    }
    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: #f4f1e8;
      border: 2px solid var(--primary-dark);
      border-radius: 4px;
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .submit-btn:hover { background: var(--primary-light); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .success-msg {
      background: #e8f5e9;
      color: var(--success);
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .error-msg {
      background: #fce4ec;
      color: var(--error);
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    /* My Rounds */
    .rounds-list {
      max-width: 700px;
      margin: 0 auto;
    }
    .round-card {
      display: flex;
      gap: 20px;
      padding: 22px 24px;
      background: white;
      border: 2px solid var(--border-light);
      border-radius: 12px;
      margin-bottom: 14px;
      align-items: center;
      opacity: 0;
      animation: fadeInUp var(--anim-normal) var(--ease-out) forwards;
      transition: all var(--anim-fast) var(--ease-out);
    }
    .round-card:nth-child(1) { animation-delay: 100ms; }
    .round-card:nth-child(2) { animation-delay: 150ms; }
    .round-card:nth-child(3) { animation-delay: 200ms; }
    .round-card:nth-child(4) { animation-delay: 250ms; }
    .round-card:nth-child(5) { animation-delay: 300ms; }
    .round-card:hover {
      border-color: var(--primary);
      transform: translateX(6px);
      box-shadow: 0 6px 24px rgba(61, 41, 20, 0.1);
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .round-score {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-family: 'DM Mono', monospace;
      font-size: 1.5rem;
      font-weight: 500;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(45, 90, 39, 0.3);
      transition: transform var(--anim-fast) var(--ease-spring);
    }
    .round-card:hover .round-score {
      transform: scale(1.1) rotate(-5deg);
    }
    .round-info { flex: 1; }
    .round-course {
      font-family: 'Playfair Display', Georgia, serif;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }
    .round-course a {
      color: inherit;
      text-decoration: none;
      transition: color var(--anim-fast);
    }
    .round-course a:hover { color: var(--primary); }
    .round-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Passport */
    .passport-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .passport-header {
      text-align: center;
      margin-bottom: 32px;
    }
    .passport-progress {
      background: var(--bg-paper);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .passport-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      transition: width 0.5s ease;
    }
    .passport-stats {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.2rem;
    }
    .passport-stats strong { color: var(--primary); }
    .passport-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 14px;
    }
    .passport-stamp {
      aspect-ratio: 1;
      background: white;
      border: 2px dashed var(--border-light);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-align: center;
      padding: 10px;
      opacity: 0.4;
      text-decoration: none;
      transition: all var(--anim-fast) var(--ease-out);
      position: relative;
      overflow: hidden;
    }
    .passport-stamp::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(45, 90, 39, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all var(--anim-normal) var(--ease-out);
    }
    .passport-stamp:hover {
      border-color: var(--primary);
      opacity: 0.6;
      transform: scale(1.02);
    }
    .passport-stamp:hover::before {
      width: 150%;
      height: 150%;
    }
    .passport-stamp.earned {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: 2px solid var(--primary-dark);
      color: #fff;
      opacity: 1;
      box-shadow: 0 4px 16px rgba(45, 90, 39, 0.3);
      animation: stampIn var(--anim-normal) var(--ease-spring) forwards;
    }
    @keyframes stampIn {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .passport-stamp.earned:hover {
      transform: scale(1.08) rotate(-3deg);
      box-shadow: 0 8px 24px rgba(45, 90, 39, 0.4);
    }
    .passport-stamp.earned::after {
      content: '';
      position: absolute;
      top: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E") center/contain no-repeat;
    }
    .stamp-initial {
      font-size: 1.4rem;
      margin-bottom: 4px;
    }
    .stamp-name {
      font-size: 0.65rem;
      line-height: 1.2;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Bay Area Golf</h1>
      <div class="header-nav">
        <a href="/account.html" class="nav-link" id="auth-link">Sign In</a>
        <a href="/" class="nav-link">Map</a>
        <a href="/courses.html" class="nav-link">Courses</a>
        <a href="/community.html" class="nav-link">Community</a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-title">
      <h2>Scorebook</h2>
      <p>Track your rounds & earn your Bay Area Golf Passport</p>
    </div>

    <!-- Auth Required State -->
    <div id="auth-required" class="auth-required">
      <div class="auth-required-icon">
        <svg viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
      </div>
      <h3>Sign In to Track Your Rounds</h3>
      <p>Create a free account to log scores, track stats, and earn your Bay Area Golf Passport.</p>
      <a href="/account.html" class="cta-btn">Create Account</a>
    </div>

    <!-- Logged In Content -->
    <div id="logged-in-content" class="hidden">
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('log')">Log Round</button>
        <button class="tab-btn" onclick="showTab('rounds')">My Rounds</button>
        <button class="tab-btn" onclick="showTab('passport')">Passport</button>
      </div>

      <!-- Log Round Tab -->
      <div class="tab-content active" id="log-tab">
        <form class="log-round-form" onsubmit="handleLogRound(event)">
          <div id="form-messages"></div>
          <div class="form-group">
            <label for="course-select">Course</label>
            <select id="course-select" required>
              <option value="">Select a course...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="round-date">Date</label>
            <input type="date" id="round-date" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="total-score">Total Score</label>
              <input type="number" id="total-score" min="30" max="200" placeholder="e.g. 85">
            </div>
            <div class="form-group">
              <label for="total-putts">Total Putts</label>
              <input type="number" id="total-putts" min="10" max="100" placeholder="e.g. 32">
            </div>
          </div>
          <div class="form-group">
            <label for="round-notes">Notes (optional)</label>
            <textarea id="round-notes" rows="3" placeholder="How did it go?"></textarea>
          </div>
          <button type="submit" class="submit-btn" id="submit-btn">Log Round</button>
        </form>
      </div>

      <!-- My Rounds Tab -->
      <div class="tab-content" id="rounds-tab">
        <div class="rounds-list" id="rounds-list">
          <div class="loading">Loading rounds...</div>
        </div>
      </div>

      <!-- Passport Tab -->
      <div class="tab-content" id="passport-tab">
        <div class="passport-container">
          <div class="passport-header">
            <div class="passport-progress">
              <div class="passport-progress-bar" id="passport-progress" style="width: 0%"></div>
            </div>
            <div class="passport-stats">
              <strong id="passport-played">0</strong> of <strong id="passport-total">28</strong> courses played
            </div>
          </div>
          <div class="passport-grid" id="passport-grid">
            <div class="loading">Loading passport...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = '/api';
    let courses = [];
    let currentUser = null;

    function getToken() {
      return localStorage.getItem('authToken');
    }

    async function checkAuth() {
      const token = getToken();
      if (token) {
        try {
          const res = await fetch(`${API_BASE}/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (res.ok) {
            const data = await res.json();
            currentUser = data.user;
            document.getElementById('auth-link').textContent = data.user.displayName || 'Account';
          }
        } catch (e) {}
      }
      // Always show content for all users
      showLoggedIn();
    }

    function showLoggedIn() {
      document.getElementById('auth-required').classList.add('hidden');
      document.getElementById('logged-in-content').classList.remove('hidden');
      loadCourses();
      // Set default date to today
      document.getElementById('round-date').value = new Date().toISOString().split('T')[0];
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active',
          (tab === 'log' && i === 0) ||
          (tab === 'rounds' && i === 1) ||
          (tab === 'passport' && i === 2)
        );
      });
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.add('active');

      if (tab === 'rounds') loadRounds();
      if (tab === 'passport') loadPassport();
    }

    async function loadCourses() {
      try {
        const res = await fetch(`${API_BASE}/courses?all=true`);
        courses = await res.json();
        const select = document.getElementById('course-select');
        select.innerHTML = '<option value="">Select a course...</option>' +
          courses.map(c => `<option value="${c.id}">${c.name} - ${c.city}</option>`).join('');
      } catch (e) {
        console.error('Error loading courses:', e);
      }
    }

    async function handleLogRound(e) {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const msgContainer = document.getElementById('form-messages');
      msgContainer.innerHTML = '';

      try {
        const res = await fetch(`${API_BASE}/user/rounds`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({
            courseId: document.getElementById('course-select').value,
            date: document.getElementById('round-date').value,
            totalScore: document.getElementById('total-score').value || null,
            totalPutts: document.getElementById('total-putts').value || null,
            notes: document.getElementById('round-notes').value || null
          })
        });

        if (res.ok) {
          msgContainer.innerHTML = '<div class="success-msg">Round logged successfully!</div>';
          // Reset form
          document.getElementById('course-select').value = '';
          document.getElementById('total-score').value = '';
          document.getElementById('total-putts').value = '';
          document.getElementById('round-notes').value = '';
        } else {
          const data = await res.json();
          msgContainer.innerHTML = `<div class="error-msg">${data.error || 'Failed to log round'}</div>`;
        }
      } catch (e) {
        msgContainer.innerHTML = '<div class="error-msg">Network error. Please try again.</div>';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Log Round';
      }
    }

    async function loadRounds() {
      const container = document.getElementById('rounds-list');
      container.innerHTML = '<div class="loading">Loading rounds...</div>';

      try {
        const res = await fetch(`${API_BASE}/user/rounds`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const rounds = await res.json();

        if (rounds.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No rounds logged yet. Log your first round to see it here!</p>
            </div>
          `;
          return;
        }

        container.innerHTML = rounds.map(r => `
          <div class="round-card">
            <div class="round-score">${r.total_score || '--'}</div>
            <div class="round-info">
              <div class="round-course">
                <a href="/course/${r.slug}">${r.course_name}</a>
              </div>
              <div class="round-meta">
                ${formatDate(r.date)} &bull; ${r.city}
                ${r.total_putts ? ` &bull; ${r.total_putts} putts` : ''}
              </div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        container.innerHTML = '<div class="loading">Error loading rounds</div>';
      }
    }

    async function loadPassport() {
      const container = document.getElementById('passport-grid');
      container.innerHTML = '<div class="loading">Loading passport...</div>';

      try {
        const [passportRes, allCoursesRes] = await Promise.all([
          fetch(`${API_BASE}/user/passport`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
          }),
          fetch(`${API_BASE}/courses?all=true`)
        ]);

        const passport = await passportRes.json();
        const allCourses = await allCoursesRes.json();

        // Update progress
        document.getElementById('passport-played').textContent = passport.played.length;
        document.getElementById('passport-total').textContent = passport.totalCourses;
        document.getElementById('passport-progress').style.width = `${passport.completionPercent}%`;

        // Create set of played course IDs
        const playedIds = new Set(passport.played.map(c => c.id));

        // Render all courses
        container.innerHTML = allCourses.map(course => {
          const played = playedIds.has(course.id);
          const initial = course.name.split(' ').map(w => w[0]).join('').slice(0, 2);
          return `
            <a href="/course/${course.slug}" class="passport-stamp ${played ? 'earned' : ''}" title="${course.name}">
              <span class="stamp-initial">${initial}</span>
              <span class="stamp-name">${course.name.length > 18 ? course.name.slice(0, 15) + '...' : course.name}</span>
            </a>
          `;
        }).join('');
      } catch (e) {
        container.innerHTML = '<div class="loading">Error loading passport</div>';
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Initialize
    checkAuth();
  </script>
</body>
</html>
